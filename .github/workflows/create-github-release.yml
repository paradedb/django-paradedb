name: Create GitHub Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "The version to release, in semver format (e.g., 0.1.0). This must match version in pyproject.toml."
        type: string
        required: true
        default: ""
      beta:
        description: "Whether this release is a beta/prerelease. Defaults to false."
        type: boolean
        required: false
        default: false
      confirmation:
        description: "I confirm that version was incremented, tests pass, and CHANGELOG was updated. Defaults to false."
        type: boolean
        required: true
        default: false

concurrency:
  group: create-github-release-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Confirm Pre-Release Checklist Was Completed
        run: |
          echo "Confirmation: ${{ github.event.inputs.confirmation }}"
          if [[ "${{ github.event.inputs.confirmation }}" == "true" ]]; then
            echo "Thank you for confirming that version was incremented, tests pass, and CHANGELOG was updated."
          else
            echo "Confirmation failed! Please confirm that version was incremented, tests pass, and CHANGELOG was updated."
            exit 1
          fi

      - name: Checkout Git Repository
        uses: actions/checkout@v6

      - name: Validate pyproject.toml Version
        run: |
          echo "Checking for existing release..."
          if gh release view v${{ github.event.inputs.version }} > /dev/null 2>&1; then
            echo "Release v${{ github.event.inputs.version }} already exists. All releases must be unique."
            exit 1
          fi
          echo "Release check passed!"

          if [[ "${{ github.event.inputs.beta }}" == "true" ]]; then
            echo "Validating that version contains alpha/beta/rc suffix..."
            if [[ "${{ github.event.inputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "Version (${{ github.event.inputs.version }}) does not contain prerelease suffix but is marked as beta."
              exit 1
            fi
          fi

          PYPROJECT_VERSION=$(grep -E '^version = ' pyproject.toml | cut -d'"' -f2)
          echo "Validating that version in pyproject.toml matches upcoming version..."
          if [[ "${{ github.event.inputs.version }}" != "$PYPROJECT_VERSION" ]]; then
            echo "Version in pyproject.toml ($PYPROJECT_VERSION) does not match upcoming version (${{ github.event.inputs.version }})."
            exit 1
          fi
          echo "Version check passed!"

      - name: Determine if Release Should be Marked as Latest
        id: release_latest
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          current_tag_version="${{ github.event.inputs.version }}"
          latest_tag_version=$(gh release list --jq '.[] | select(.isLatest == true) | .name' --json=name,isLatest | sed 's/^v//')
          echo "Current latest release is $latest_tag_version"
          echo "Current version to be released is $current_tag_version"

          echo ""
          echo "Install semver CLI via npm to compare versions..."
          npm install semver

          echo ""
          echo "Comparing versions to determine if current version is latest..."
          if npx semver -r ">$latest_tag_version" "$current_tag_version"; then
            echo "is_latest=true"
            echo "is_latest=true" >> $GITHUB_OUTPUT
          else
            echo "is_latest=false"
            echo "is_latest=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          target_commitish: ${{ github.ref_name }}
          prerelease: ${{ github.event.inputs.beta }}
          make_latest: ${{ steps.release_latest.outputs.is_latest }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ github.token }}
