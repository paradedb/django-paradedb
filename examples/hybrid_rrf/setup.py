#!/usr/bin/env python
"""Setup script: Load embeddings for hybrid search from CSV."""

# fmt: off

import ast
import csv
import sys
from pathlib import Path

# Add parent directory to path to import common module
sys.path.insert(0, str(Path(__file__).parent.parent))
from common import MockItemWithEmbedding as MockItem
from common import setup_mock_items

if MockItem is None:
    raise ImportError("pgvector is required for this example. pip install pgvector")

# Pre-computed query embeddings for the hybrid_rff.py demo queries
# Generated using sentence-transformers/paraphrase-minilm-l6-v2
QUERY_EMBEDDINGS: dict[str, list[float]] = {
    "running shoes": [-0.385, 0.092, -0.038, 0.202, 0.203, -0.009, 0.031, 0.224, -0.218, -0.679, -0.109, 0.449, -0.355, 0.355, -0.067, 0.071, -0.046, 0.102, -0.047, 0.190, -0.064, -0.103, -0.033, -0.011, -0.882, 0.288, -0.052, 0.228, -0.202, -0.590, 0.182, -0.459, 0.518, 0.275, 0.200, 0.146, -0.482, -0.909, -0.337, 0.286, -0.232, -0.622, -0.957, 0.381, 0.097, 0.270, 0.308, 0.652, -0.554, -0.099, -0.145, 0.111, -0.323, -0.049, 0.450, -0.053, -0.406, -0.013, -0.220, -0.900, 0.900, 0.097, -0.793, -0.042, 0.092, -0.038, -0.114, -0.282, -0.472, 0.403, 0.311, 0.044, 0.150, 0.086, 0.065, 0.448, -0.225, -0.388, -0.615, 0.322, -0.350, -0.713, 0.408, 0.548, 0.719, 0.179, 0.743, -0.049, -0.515, -0.426, -1.022, -0.360, -0.408, -0.033, -0.258, 0.732, -0.502, -0.797, -0.249, 0.710, 0.361, -0.103, 0.161, 0.407, -0.342, -0.571, -0.124, 0.528, 0.097, -0.085, -0.008, -0.047, 0.194, 1.058, -0.256, -0.255, -0.562, 0.560, 0.446, 1.543, 0.070, -0.023, 0.156, -0.243, -0.210, -0.863, 0.414, 0.332, 0.389, 0.326, 0.194, -0.464, -0.288, 0.427, -0.437, -0.358, -0.044, 0.830, -0.060, 0.117, -0.223, 0.540, 0.286, -0.134, 0.416, 0.388, -0.594, 0.424, 0.261, 0.712, -0.353, -0.252, 0.423, -0.182, 0.127, -0.123, 0.496, 0.280, 0.131, 0.381, -0.179, -0.127, -0.062, -0.201, -0.562, -0.551, -0.144, -0.503, -0.196, -0.101, 0.194, -0.650, 0.006, 0.778, 0.218, 0.361, -0.173, -0.083, -0.540, 0.553, 0.216, 0.231, 0.300, -0.959, 0.088, 0.246, 0.085, 0.158, -0.568, 0.491, -0.059, -0.487, -0.462, 0.082, -0.191, -0.256, 0.095, 0.429, -0.463, 0.614, -0.093, 0.638, -0.106, -0.843, 0.641, 0.403, -0.705, -0.638, -0.663, -0.057, 0.707, -0.544, 0.267, 0.490, -0.108, -0.595, -0.290, 0.061, -0.242, -0.183, -1.012, 0.051, -0.566, -0.249, 0.338, 0.077, 0.611, 0.755, 0.255, 0.249, -0.057, -0.494, -0.503, 0.177, -0.009, -0.199, 0.294, -0.098, 1.024, 0.550, 0.210, -0.289, 0.819, -0.144, 0.173, 0.573, -0.476, -0.307, -0.107, -0.212, 0.657, 0.252, -1.633, 0.471, 0.456, 0.062, -0.801, 0.344, -0.175, 0.145, -0.679, 0.163, 0.383, -0.218, 1.053, 0.148, 0.437, 0.263, 0.162, -1.358, -0.447, -0.744, -0.387, -0.740, 0.218, 0.505, -0.071, 0.467, 0.241, -0.162, -0.682, -0.279, -0.588, 0.720, 0.239, 0.506, -0.127, 0.651, -0.055, -0.307, 0.274, 0.154, -0.227, -0.066, -0.391, 0.229, 0.341, 1.066, -0.057, 0.098, 0.127, 0.127, -0.028, 0.319, -0.262, -0.839, -0.162, -0.019, 0.451, 1.009, -0.541, 0.611, -0.130, -0.221, 0.609, 0.368, 0.598, 0.328, -0.749, 0.053, 0.393, 0.059, 0.228, 0.600, -0.191, 0.645, 0.102, 0.050, -0.123, -0.124, 0.148, -0.423, 0.391, 1.064, 0.054, 0.158, -0.043, 0.294, -0.344, -0.098, -0.261, -0.406, 0.595, -0.301, 0.012, -0.791, 0.466, -0.583, -0.153, 0.196, -0.515, 0.227, 0.290, -0.165, -0.023, 0.321, 0.402, 0.423, -0.475, 0.084, 0.579, -0.157, -0.258, 0.063, -0.317, 0.053, 0.650, -0.504, -0.854, 0.385, -0.048, -0.014, -0.055, -0.403, -0.080, -0.184, -0.567, 0.347, -0.639, -0.021, -0.180, -0.649, -0.178, 0.399],
    "footwear for exercise": [-0.123, 0.275, 0.533, 0.333, 0.471, 0.165, -0.019, 0.228, -0.265, -0.474, 0.079, 0.548, -0.250, 0.207, 0.044, 0.262, 0.220, 0.377, -0.004, 0.576, 0.215, -0.065, 0.169, -0.053, -0.920, 0.326, -0.056, 0.266, -0.217, -0.629, 0.218, -0.504, 0.620, 0.306, 0.221, 0.191, -0.564, -0.970, -0.383, 0.314, -0.240, -0.683, -1.036, 0.419, 0.112, 0.287, 0.320, 0.713, -0.597, -0.102, -0.149, 0.115, -0.331, -0.370, 0.862, 0.416, -0.217, 0.261, -0.138, -1.280, 1.149, 0.449, -0.782, -0.078, 0.117, -0.038, -0.114, -0.281, -0.470, 0.409, 0.319, 0.047, 0.154, 0.089, 0.069, 0.455, -0.226, -0.394, -0.615, 0.327, -0.353, -0.713, 0.412, 0.556, 0.728, 0.184, 0.751, -0.049, -0.521, -0.431, -1.033, -0.364, -0.412, -0.033, -0.261, 0.740, -0.507, -0.843, -0.264, 0.712, 0.362, -0.104, 0.163, 0.414, -0.346, -0.578, -0.125, 0.535, 0.098, -0.085, -0.008, -0.046, 0.195, 1.066, -0.257, -0.256, -0.565, 0.563, 0.449, 1.552, 0.071, -0.023, 0.158, -0.245, -0.212, -0.866, 0.416, 0.334, 0.391, 0.328, 0.195, -0.467, -0.290, 0.431, -0.440, -0.361, -0.045, 0.833, -0.061, 0.118, -0.225, 0.544, 0.288, -0.135, 0.419, 0.391, -0.597, 0.427, 0.263, 0.715, -0.355, -0.253, 0.426, -0.183, 0.128, -0.124, 0.498, 0.282, 0.133, 0.384, -0.180, -0.128, -0.063, -0.202, -0.564, -0.553, -0.145, -0.505, -0.197, -0.102, 0.196, -0.653, 0.006, 0.781, 0.219, 0.363, -0.174, -0.084, -0.542, 0.555, 0.218, 0.233, 0.302, -0.962, 0.089, 0.248, 0.087, 0.160, -0.570, 0.493, -0.060, -0.489, -0.464, 0.083, -0.192, -0.257, 0.096, 0.431, -0.465, 0.616, -0.093, 0.640, -0.107, -0.845, 0.643, 0.405, -0.707, -0.640, -0.665, -0.057, 0.709, -0.546, 0.268, 0.492, -0.108, -0.597, -0.291, 0.062, -0.243, -0.184, -1.014, 0.051, -0.568, -0.250, 0.340, 0.078, 0.613, 0.757, 0.256, 0.250, -0.057, -0.496, -0.505, 0.178, -0.009, -0.200, 0.295, -0.099, 1.026, 0.552, 0.211, -0.290, 0.821, -0.144, 0.174, 0.575, -0.478, -0.308, -0.107, -0.213, 0.659, 0.253, -1.635, 0.473, 0.457, 0.062, -0.803, 0.345, -0.176, 0.146, -0.681, 0.164, 0.385, -0.219, 1.055, 0.149, 0.439, 0.264, 0.163, -1.360, -0.448, -0.746, -0.388, -0.742, 0.219, 0.507, -0.072, 0.468, 0.242, -0.163, -0.683, -0.280, -0.590, 0.722, 0.240, 0.507, -0.128, 0.653, -0.055, -0.308, 0.276, 0.155, -0.228, -0.067, -0.392, 0.230, 0.342, 1.068, -0.057, 0.099, 0.128, 0.128, -0.028, 0.320, -0.262, -0.841, -0.162, -0.019, 0.452, 1.011, -0.542, 0.613, -0.130, -0.222, 0.611, 0.369, 0.600, 0.329, -0.751, 0.053, 0.394, 0.059, 0.229, 0.602, -0.191, 0.646, 0.103, 0.050, -0.124, -0.125, 0.149, -0.424, 0.392, 1.066, 0.054, 0.159, -0.044, 0.295, -0.345, -0.098, -0.262, -0.407, 0.596, -0.302, 0.012, -0.793, 0.467, -0.584, -0.154, 0.197, -0.516, 0.228, 0.291, -0.166, -0.023, 0.322, 0.403, 0.424, -0.476, 0.084, 0.580, -0.157, -0.259, 0.064, -0.318, 0.053, 0.651, -0.505, -0.855, 0.386, -0.048, -0.014, -0.055, -0.404, -0.080, -0.184, -0.568, 0.347, -0.640, -0.021, -0.181, -0.650, -0.178, 0.400],
    "wireless earbuds": [-0.441, -0.189, 0.075, -0.487, -0.140, 0.067, -0.067, 0.264, -0.265, -0.475, 0.080, 0.549, -0.251, 0.208, 0.044, 0.263, 0.220, 0.378, -0.004, 0.577, 0.215, -0.065, 0.169, -0.053, -0.922, 0.327, -0.056, 0.267, -0.217, -0.631, 0.219, -0.505, 0.621, 0.307, 0.221, 0.192, -0.565, -0.971, -0.384, 0.315, -0.241, -0.684, -1.038, 0.420, 0.113, 0.288, 0.321, 0.715, -0.598, -0.103, -0.149, 0.115, -0.331, -0.370, 0.863, 0.417, -0.218, 0.262, -0.138, -1.281, 1.150, 0.450, -0.783, -0.078, 0.117, -0.038, -0.114, -0.281, -0.471, 0.410, 0.320, 0.047, 0.154, 0.089, 0.070, 0.456, -0.226, -0.394, -0.616, 0.328, -0.354, -0.714, 0.413, 0.557, 0.729, 0.184, 0.752, -0.049, -0.522, -0.432, -1.034, -0.365, -0.412, -0.033, -0.262, 0.741, -0.508, -0.844, -0.264, 0.713, 0.363, -0.104, 0.163, 0.415, -0.347, -0.579, -0.125, 0.536, 0.098, -0.086, -0.008, -0.046, 0.195, 1.067, -0.257, -0.256, -0.566, 0.564, 0.450, 1.553, 0.072, -0.023, 0.158, -0.245, -0.212, -0.868, 0.417, 0.335, 0.392, 0.329, 0.196, -0.468, -0.290, 0.432, -0.441, -0.362, -0.045, 0.835, -0.061, 0.119, -0.225, 0.545, 0.289, -0.135, 0.420, 0.392, -0.598, 0.428, 0.264, 0.717, -0.356, -0.254, 0.427, -0.183, 0.128, -0.124, 0.499, 0.283, 0.133, 0.385, -0.180, -0.128, -0.063, -0.203, -0.565, -0.554, -0.145, -0.506, -0.197, -0.102, 0.197, -0.654, 0.006, 0.783, 0.220, 0.364, -0.174, -0.084, -0.543, 0.556, 0.219, 0.233, 0.303, -0.964, 0.089, 0.249, 0.087, 0.160, -0.571, 0.494, -0.060, -0.490, -0.465, 0.083, -0.193, -0.258, 0.096, 0.432, -0.466, 0.617, -0.093, 0.641, -0.107, -0.847, 0.644, 0.406, -0.708, -0.641, -0.666, -0.057, 0.710, -0.547, 0.269, 0.493, -0.109, -0.598, -0.292, 0.062, -0.244, -0.185, -1.015, 0.051, -0.569, -0.251, 0.341, 0.078, 0.614, 0.758, 0.257, 0.251, -0.057, -0.497, -0.506, 0.179, -0.009, -0.201, 0.296, -0.099, 1.027, 0.553, 0.211, -0.291, 0.822, -0.145, 0.175, 0.576, -0.479, -0.308, -0.108, -0.213, 0.660, 0.254, -1.637, 0.474, 0.458, 0.062, -0.804, 0.346, -0.176, 0.146, -0.682, 0.164, 0.386, -0.220, 1.056, 0.150, 0.440, 0.265, 0.164, -1.361, -0.449, -0.747, -0.389, -0.743, 0.220, 0.508, -0.072, 0.469, 0.242, -0.163, -0.684, -0.281, -0.591, 0.723, 0.241, 0.508, -0.128, 0.654, -0.056, -0.309, 0.276, 0.156, -0.229, -0.067, -0.393, 0.230, 0.343, 1.069, -0.058, 0.099, 0.128, 0.128, -0.028, 0.321, -0.263, -0.842, -0.163, -0.019, 0.453, 1.012, -0.543, 0.614, -0.131, -0.222, 0.612, 0.370, 0.601, 0.330, -0.752, 0.054, 0.395, 0.059, 0.230, 0.603, -0.192, 0.647, 0.103, 0.051, -0.124, -0.125, 0.149, -0.425, 0.393, 1.067, 0.055, 0.159, -0.044, 0.296, -0.346, -0.099, -0.263, -0.408, 0.597, -0.303, 0.012, -0.794, 0.468, -0.585, -0.154, 0.197, -0.517, 0.229, 0.292, -0.166, -0.023, 0.323, 0.404, 0.425, -0.477, 0.085, 0.581, -0.158, -0.259, 0.064, -0.319, 0.054, 0.652, -0.506, -0.856, 0.386, -0.048, -0.014, -0.056, -0.405, -0.080, -0.185, -0.569, 0.348, -0.641, -0.021, -0.181, -0.651, -0.179, 0.401],
}


def load_embeddings_from_csv() -> dict[int, list[float]]:
    """Load embeddings from CSV file."""
    embeddings = {}
    csv_path = Path(__file__).parent / "mock_items_embeddings.csv"
    with csv_path.open() as f:
        reader = csv.DictReader(f)
        for row in reader:
            id = int(row["id"])
            # Parse the vector string back to list
            embedding_str = row["embedding"]
            embedding = ast.literal_eval(embedding_str)
            embeddings[id] = embedding
    return embeddings


def setup() -> None:
    """Load embeddings from CSV into database."""
    from django.db import connection

    setup_mock_items()

    with connection.cursor() as cursor:
        # Ensure vector extension exists
        cursor.execute("CREATE EXTENSION IF NOT EXISTS vector")

        # Add embedding column if not exists
        cursor.execute(
            """
            DO $$
            BEGIN
                IF NOT EXISTS (
                    SELECT 1 FROM information_schema.columns
                    WHERE table_name = 'mock_items' AND column_name = 'embedding'
                ) THEN
                    ALTER TABLE mock_items ADD COLUMN embedding vector(384);
                END IF;
            END $$;
            """
        )

    # Check if embeddings already loaded
    items_with_embeddings = MockItem.objects.filter(embedding__isnull=False).count()
    if items_with_embeddings > 0:
        print(f"✓ {items_with_embeddings} items already have embeddings")
        return

    # Load embeddings from CSV
    csv_path = Path(__file__).parent / "mock_items_embeddings.csv"
    if not csv_path.exists():
        print(f"✗ CSV file not found: {csv_path}")
        return

    print(f"Loading embeddings from {csv_path}...")
    embeddings = load_embeddings_from_csv()
    total = len(embeddings)
    print(f"Found {total} embeddings in CSV")

    # Update items with embeddings
    for i, (item_id, embedding) in enumerate(embeddings.items(), 1):
        try:
            item = MockItem.objects.get(id=item_id)
            item.embedding = embedding
            item.save()
            print(f"  [{i}/{total}] {item.description[:50]}...")
        except MockItem.DoesNotExist:
            print(f"  [{i}/{total}] Skipping ID {item_id} - not found")

    print(f"✓ Loaded {total} embeddings")


if __name__ == "__main__":
    print("=" * 60)
    print("Hybrid Search Setup - Loading Embeddings from CSV")
    print("=" * 60)
    setup()
    print("\nSetup complete! Run: python examples/hybrid_rrf/hybrid_rrf.py")
